<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <title>{{ app_name }} Dashboard</title>
    <link rel="icon" href="{{ favicon }}">
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
            padding: 15px;
        }

        .app-header {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            text-transform: uppercase;
        }

        .org-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: #007bff;
            letter-spacing: 1px;
            display: block;
            margin-bottom: 5px;
        }

        .btn-big {
            width: 100%;
            padding: 25px 10px;
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            text-transform: uppercase;
        }

        .card-status {
            background: white;
            border-radius: 12px;
            padding: 20px 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            color: #333;
            transition: transform 0.1s;
        }

        .card-status:active {
            transform: scale(0.98);
        }

        .status-green {
            background-color: #28a745 !important;
            color: white !important;
        }

        .status-red {
            background-color: #dc3545 !important;
            color: white !important;
        }

        .status-gold {
            background-color: #ffc107 !important;
            color: #333 !important;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .footer-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin: 2px;
        }

        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        body.dark-mode .app-header {
            color: #fff;
        }

        body.dark-mode .card-status {
            background-color: #1e1e1e;
            color: #fff;
        }

        hr.header-sep {
            margin: 15px 0 25px 0;
            opacity: 0.2;
        }

        #tzAlert {
            display: none;
            background: #ff9800;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        a {
            text-decoration: none;
            color: inherit;
        }
    </style>
</head>

<body>
    {% include '_nav.html' %}
    <div id="tzAlert">⚠️ Timezone Mismatch: Check Server Time</div>

    <div class="app-header">
        {% if org_name %}<span class="org-name">{{ org_name }}</span>{% endif %}
        <div style="font-size: 1.5rem; font-weight: 900; letter-spacing: 2px;">{{ app_name }}</div>
        <div id="welcomeUser" style="font-size: 0.8rem; margin-top: 5px; opacity: 0.6;"></div>
        <hr class="header-sep">
    </div>

    <div class="row">
        <div class="col-6"><a href="/scan" class="btn btn-primary btn-big">SCAN MODE</a></div>
        <div class="col-6"><a href="/history" class="btn btn-secondary btn-big">HISTORY</a></div>
    </div>

    <div class="row">
        <div class="col-6">
            <a href="/expected">
                <div class="card-status status-{{ stats.expected.status }}" id="card-expected">
                    <span class="stat-label">Expected Today</span>
                    <span class="stat-number" id="val-expected">{{ stats.expected.scanned }} / {{ stats.expected.total
                        }}</span>
                </div>
            </a>
        </div>
        <div class="col-6">
            <a href="/past_due">
                <div class="card-status status-{{ stats.past_due.status }}" id="card-pastdue">
                    <span class="stat-label">Past Due</span>
                    <span class="stat-number" id="val-pastdue">{{ stats.past_due.count }}</span>
                </div>
            </a>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <a href="/history?filter=14days">
            <div class="card-status"
                style="position: relative; overflow: hidden; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">
                <div style="position: relative; z-index: 2;">
                    <span class="stat-label">Analytics</span>
                    <span class="stat-number" id="val-scanned">{{ scans }}</span>
                    <div style="font-size: 0.7rem; opacity: 0.8;">Scans (Last 14 Days)</div>
                </div>
                <!-- Sparkline Canvas -->
                <canvas id="scannedSparkline"
                    style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 1; opacity: 0.5; pointer-events: none;"></canvas>
            </div>
        </a>

        <div class="row">
            <div class="col-6">
                <a href="/open_returns">
                    <div class="card-status status-{{ stats.returns.status }}" id="card-returns">
                        <span class="stat-label">Open Returns</span>
                        <span class="stat-number" id="val-returns">{{ stats.returns.open }}</span>
                    </div>
                </a>
            </div>
            <div class="col-6">
                <a href="/refunded_log">
                    <div class="card-status status-{{ stats.refunded.status }}" id="card-refunded">
                        <span class="stat-label">Refunded</span>
                        <span class="stat-number" id="val-refunded">{{ stats.refunded.count }}</span>
                    </div>
                </a>
            </div>
        </div>

        <a href="/settings" class="btn btn-outline-secondary w-100 mb-3"
            style="border-radius: 12px; margin-top: 20px;">Settings</a>

        <div class="text-center mb-5">
            {% for r in refresh_info %}
            <span
                class="footer-badge text-white bg-{{ 'secondary' if r.status == 'grey' else 'success' if r.status == 'green' else 'danger' }}">
                {{ r.label }}: {{ r.age }}{% if r.status != 'grey' %}h{% endif %}
            </span>
            {% endfor %}
        </div>

        <script>
            // Live Dashboard Logic
            let sparkChart = null;

            function updateStats() {
                fetch('/api/dashboard_stats')
                    .then(response => response.json())
                    .then(data => {
                        const s = data.stats;
                        const g = data.graph; // Analytics Data

                        // Update Numbers
                        document.getElementById('val-expected').innerText = `${s.expected.scanned} / ${s.expected.total}`;
                        document.getElementById('val-pastdue').innerText = s.past_due.count;
                        document.getElementById('val-scanned').innerText = data.scans;
                        document.getElementById('val-returns').innerText = s.returns.open;
                        document.getElementById('val-refunded').innerText = s.refunded.count;

                        // Update Colors (Classes)
                        updateStatus('card-expected', s.expected.status);
                        updateStatus('card-pastdue', s.past_due.status);
                        updateStatus('card-returns', s.returns.status);
                        updateStatus('card-refunded', s.refunded.status);

                        // Render Sparkline if not already
                        if (g && !sparkChart) {
                            const ctx = document.getElementById('scannedSparkline').getContext('2d');
                            sparkChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: g.map(d => {
                                        const parts = d.date.split('-');
                                        return `${parts[1]}/${parts[2]}`; // MM/DD
                                    }),
                                    datasets: [{
                                        data: g.map(d => d.count),
                                        borderColor: '#007bff',
                                        backgroundColor: 'rgba(0, 123, 255, 0.25)',
                                        borderWidth: 2,
                                        tension: 0.4,
                                        fill: true,
                                        pointRadius: 2, // Small dots
                                        pointBackgroundColor: '#007bff'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                                    scales: {
                                        x: {
                                            display: true, // Show Axis
                                            grid: { display: false, drawBorder: false },
                                            ticks: {
                                                font: { size: 9 },
                                                color: '#666',
                                                maxRotation: 0,
                                                autoSkip: true,
                                                maxTicksLimit: 7
                                            }
                                        },
                                        y: { display: false, beginAtZero: true }
                                    },
                                    layout: { padding: { left: -5, right: -5, bottom: 0 } }
                                }
                            });
                        } else if (sparkChart && g) {
                            // Update Data
                            sparkChart.data.labels = g.map(d => {
                                const parts = d.date.split('-');
                                return `${parts[1]}/${parts[2]}`;
                            });
                            sparkChart.data.datasets[0].data = g.map(d => d.count);
                            sparkChart.update('none');
                        }
                    })
                    .catch(e => console.error("Stats update failed", e));
            }

            // Init
            updateStats();
            setInterval(updateStats, 5000);

            function updateStatus(id, newStatus) {
                const el = document.getElementById(id);
                if (!el) return;
                // Remove old status classes
                el.classList.remove('status-green', 'status-red', 'status-gold');
                // Add new
                if (newStatus) el.classList.add(`status-${newStatus}`);
            }

            // --- TIMEZONE CHECK ---
            // compare server time with client time
            const serverTime = {{ server_ts }};
            const clientTime = new Date().getTime();
            const diff = Math.abs(serverTime - clientTime);
            if (diff > 1000 * 60 * 60) { // > 1 hour difference
                document.getElementById('tzAlert').style.display = 'block';
            }

            const u = localStorage.getItem('dockops_user');
            if (u) document.getElementById('welcomeUser').innerText = "Logged in as: " + u;
        </script>
</body>

</html>
