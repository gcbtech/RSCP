<!DOCTYPE html>
<html>

<head>
    <title>RSCP | History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="icon" href="{{ favicon }}">
    <style>
        body {
            padding: 15px;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 800px;
            margin: auto;
        }

        .history-card {
            border-left: 5px solid #007bff;
        }
    </style>
</head>

<body>
    {% include '_nav.html' %}
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">üì¶ History</h2>
            <a href="/receiving" class="btn btn-outline-secondary">Back</a>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-white" style="cursor: pointer;" onclick="toggleFilters()">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">üîç Search & Filters</span>
                    <span id="filterIcon">‚ñº</span>
                </div>
            </div>
            <div class="card-body" id="filterCard" style="display:none;">
                <form action="/history" method="GET">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Date Range</label>
                            <div class="input-group input-group-sm">
                                <input type="date" name="start_date" class="form-control"
                                    value="{{ request.args.get('start_date', '') }}">
                                <span class="input-group-text">to</span>
                                <input type="date" name="end_date" class="form-control"
                                    value="{{ request.args.get('end_date', '') }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">User</label>
                            <select name="user_filter" class="form-select form-select-sm">
                                <option value="">All Users</option>
                                {% for u in users %}
                                <option value="{{ u }}" {% if request.args.get('user_filter')==u %}selected{% endif %}>
                                    {{ u }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Search Term</label>
                            <input type="text" name="search_term" class="form-control form-control-sm"
                                placeholder="Tracking / Item Name" value="{{ request.args.get('search_term', '') }}">
                        </div>
                        <div class="col-12 text-end mt-2">
                            <a href="/history" class="btn btn-sm btn-outline-secondary me-1">Reset</a>
                            <button type="submit" class="btn btn-sm btn-primary">Apply Filters</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Client Filter (Hidden if Server Search active?) No, keep for refinement -->


        <div class="list-group" id="historyList">
            {% for row in history %}
            <div class="list-group-item list-group-item-action flex-column align-items-start p-3 mb-2 shadow-sm history-card"
                style="border-radius: 8px;">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1 fw-bold">{{ row['ItemName'] }}</h5>
                    <small class="text-muted">{{ row['Timestamp'].split(' ')[0] }}</small>
                </div>

                <p class="mb-2 text-primary" style="font-family: monospace; font-size: 1.1rem;">{{ row['Tracking'] }}
                </p>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-secondary">{{ row['User'] }}</span>
                        {% if row['Quantity']|int > 1 %}
                        <span class="badge bg-warning text-dark">Qty: {{ row['Quantity'] }}</span>
                        {% endif %}
                    </div>
                    <a href="/return_mode?track={{ row.Tracking }}" class="btn btn-sm btn-outline-warning">Return</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        function toggleFilters() {
            const card = document.getElementById('filterCard');
            const icon = document.getElementById('filterIcon');
            if (card.style.display === 'none') {
                card.style.display = 'block';
                icon.innerText = '‚ñ≤';
            } else {
                card.style.display = 'none';
                icon.innerText = '‚ñº';
            }
        }


    </script>
    <script>if (localStorage.getItem('rscp_darkmode') === 'true') {
            document.body.style.backgroundColor = '#121212';
            document.body.style.color = '#e0e0e0';
            document.querySelectorAll('.list-group-item').forEach(el => {
                el.style.backgroundColor = '#1e1e1e';
                el.style.color = '#fff';
                el.style.borderColor = '#444';
                el.style.borderLeftColor = '#0d6efd';
            });
        }</script>
</body>

</html>